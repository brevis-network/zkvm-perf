name: Benchmark Suite

on:
  workflow_dispatch:
    inputs:
      instances:
        required: true
        type: string
      provers:
        required: true
        type: string
      programs:
        required: true
        type: string
      shard_sizes:
        required: true
        type: string

jobs:
  sample:
    strategy:
      matrix:
        prover: ${{ fromJSON(github.event.inputs.provers) }}
        instance: ${{ fromJSON(github.event.inputs.instances) }}
        shard_size: ${{ fromJSON(github.event.inputs.shard_sizes) }}
    name: Run (${{ matrix.instance }}, ${{ matrix.prover }}, ${{ matrix.shard_size }})
    runs-on:
      [
        "runs-on",
        "runner=${{ matrix.instance }}",
        "spot=false",
        "run-id=${{ github.run_id }}",
      ]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4 

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Docker layer caching
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: zkvm-perf
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          platforms: linux/amd64

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Make benchmarks directory
        run: mkdir -p ${{ github.workspace }}/benchmarks

      - name: rust-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
            ~/.rustup/
          key: rust-1.79.0-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: rust-1.79.0-

      - name: Run benchmark
        run: |
          docker run $(echo "${{ matrix.instance }}" | grep -q "g6" && echo "--gpus all" || echo "") --platform linux/amd64 \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v ${{ github.workspace }}/benchmarks:/usr/src/app/benchmarks \
            -v ~/.cargo/registry:/root/.cargo/registry \
            -v ~/.cargo/git:/root/.cargo/git \
            -e RUST_BACKTRACE=full \
            --network host \
            zkvm-perf \
            "python3 sweep.py \
              --filename benchmark  \
              --trials 1 \
              --programs $(echo ${{ inputs.programs }} | sed 's/,/ /g') \
              --provers ${{ matrix.prover }} \
              --shard-sizes ${{ matrix.shard_size }}"

      - name: List benchmark results
        run: ls -la ${{ github.workspace }}/benchmarks

      - name: Echo benchmark results
        run: cat benchmarks/benchmarks_latest.csv

      - name: Convert CSV to JSON array
        id: convert
        run: |
          echo "json_data=$(python3 -c '
          import csv, json, sys
          with open("${{ github.workspace }}/benchmarks/benchmarks_latest.csv") as f:
              reader = csv.reader(f)
              data = list(reader)
              git_ref = "${{ github.ref }}"
              for row in data:
                  row.insert(0, git_ref)
              print(json.dumps(data))
          ')" >> $GITHUB_OUTPUT

      - name: Push to google sheets
        uses: jroehl/gsheet.action@v2.0.0
        with:
          spreadsheetId: 1dGzQbLxlQTaYgvUSnU9xmgrluE2G9WjM6cpdWC04kiw
          commands: |
            [
              { "command": "getWorksheet", "args": { "worksheetTitle": "Runs" }},
              { "command": "appendData", "args": { "data": ${{ steps.convert.outputs.json_data }} }},
            ]
        env:
          GSHEET_CLIENT_EMAIL: ${{ secrets.GSHEET_CLIENT_EMAIL }}
          GSHEET_PRIVATE_KEY: ${{ secrets.GSHEET_PRIVATE_KEY }}